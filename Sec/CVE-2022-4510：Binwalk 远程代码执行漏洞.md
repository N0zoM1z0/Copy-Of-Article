😰

---

Binwalk 是用于搜索给定二进制镜像文件以获取嵌入的文件和代码的工具。

具体来说，Binwalk是一个固件的分析工具，旨在协助研究人员对固件非分析，提取及逆向工程用处。简单易用，完全自动化脚本，并通过自定义签名，提取规则和插件模块，还重要一点的是可以轻松地扩展。

Part1

漏洞状态

| 漏洞细节 | 漏洞POC | 漏洞EXP | 在野利用 |
| -------- | ------- | ------- | -------- |
| 有       | 有      | 有      | 无       |

Part2

漏洞描述

| ‍漏洞名称 | Binwalk 远程代码执行漏洞                                     |
| -------- | ------------------------------------------------------------ |
| CVE编号  | CVE-2022-4510                                                |
| 漏洞类型 | 远程代码执行                                                 |
| 漏洞等级 | 7.8 高危 (High）                                             |
| 公开状态 | 公开                                                         |
| 漏洞描述 | 从 2.1.2b 到 2.3.3 版本的 ReFirm Labs binwalk 中发现了一个路径遍历漏洞。通过制作恶意 PFS文件系统文件，当 binwalk 在提取模式（-e 选项）下运行时，攻击者可以让 binwalk 的 PFS 提取器在任意位置提取文件。远程代码执行可以通过构建一个 PFS 文件系统来实现，该文件系统在提取时会将恶意的 binwalk 模块提取到文件夹 .config/binwalk/plugins 中从而执行代码。该漏洞与程序文件src/binwalk/plugins/unpfs.py相关。此问题会影响从 2.1.2b 到 2.3.3 的binwalk。 |
| 时间线   | 2022-10-26 漏洞提交2022-12-15 分配cve编号                    |
| 影响产品 | Binwalk v2.1.2b-2.3.3                                        |

## **分析环境:**

Kalix64

Binwalk v2.3.3

Part3

漏洞复现

### 1. 创建一个.pfs 文件头如下,然后打包成exp.zip

### 

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmaiaSK7oLVGkrcjYN9XY6k398D81X3avXPvOZLUAkVY17MRAZV6icQIlOGlaryCkl1zPYmYzzBZ2LzQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

\2. 正常binwalk执行之后输出

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmaiaSK7oLVGkrcjYN9XY6k39MrLvAcVIeIR8texLzGpX6EThY2Hb1oQrYFZQXdX82NlKUonOScNAlw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

\3. 在kali中用binwalk解析exp.zip binwalk -M -e exp.zip，并查看结果

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmaiaSK7oLVGkrcjYN9XY6k39Oz0YibUVqcVGTPKbGYVQrI44TRibSDjPqGkBzE2lePQGy0rovmHLM1Lw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmaiaSK7oLVGkrcjYN9XY6k390oDTQtzsCpicPOHYKjjWLKrOStMFPbA0XicGfpN40j7QITnHusbpiaomA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

\4. 看到在kali桌面生成了一个_exp.zip.extracted 的文件夹。文件夹下面pfs-root目录下看到123.py 是我们pfs文件头写的文件名。

\5. 构造验证pfs 并打包成exp.zip.  

\6. 构造的pfs文件头如下

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmaiaSK7oLVGkrcjYN9XY6k39azib17icBpQIylR1d2mibYaZZkESegA43qxW3Xp0bo5y6uut4YNqvNFRw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

\7. 再次在kali中用binwalk解析 exp.zip

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmaiaSK7oLVGkrcjYN9XY6k39u0mBj0IJYLBQms4fGuddal2kwTibGR9TXBTVr8ewBHZlAKpTniaxF4OQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

8.可以看到binwalk在正常输出之后又输出rce... 字段。证明复现成功！

Part4

漏洞分析

什么是PFS文件

PFS文件是由PhotoFiltre Studio（图像修饰程序）创建的选择文件。它包含图像编辑器的多边形选择工具使用的坐标，以便在给定坐标之间绘制线。PFS文件以纯文本格式存储。

漏洞源代码

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmaiaSK7oLVGkrcjYN9XY6k39VOxUj8Xn5fLqW77ZF1IgENH14FicmkXTwGpicFtz1lyadHlib9X8O0Lhg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

问题出现在红框内部的代码

在解析pfs文件头的时候，会把pfs文件头内部的文件命和out_dir 拼接。拼接之后默认走else代码分支，并且对特殊符号没有校验导致可以使用../ 符号路径穿越。再利用binwalk的plugins功能。就可以释放py文件到binwalk的plugins目录下，从而代码执行。



Part5

修复建议

\1. Binwalk软件升级到最新的2.3.4版本。

\2. 代码要检测特殊符号，防止路径穿越。